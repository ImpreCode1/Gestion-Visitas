generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  name          String
  email         String         @unique
  phone         String?
  position      String?
  department    String?
  role          String
  tipoaprobador TipoAprobador? @default(null)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relaciones
  visitasRegistradas Visita[]     @relation("VisitasGerente")
}

model Visita {
  id          Int   @id @default(autoincrement())
  gerenteId   Int
  gerente     User  @relation("VisitasGerente", fields: [gerenteId], references: [id])

  // Datos del cliente
  clienteCodigo String
  cliente       String

  direccion     String
  ciudad        String?
  pais          String?
  contacto      String?
  telefono      String?
  personaVisita String?
  motivo        String

  fecha_ida     DateTime
  fecha_regreso DateTime
  lugar         String?
  requiereAvion Boolean @default(false)
  estado        EstadoVisita @default(pendiente)

  // Relaciones
  facturas     Factura?
  aprobaciones Aprobacion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Factura {
  id         Int              @id @default(autoincrement())
  visitaId   Int              @unique // ðŸ‘ˆ asegura que solo exista un registro por visita
  visita     Visita           @relation(fields: [visitaId], references: [id])
  archivos   ArchivoFactura[] // ðŸ‘ˆ varios archivos dentro del mismo grupo
  descripcion String?
  montoTotal  Float?
  createdAt   DateTime @default(now())
}

model ArchivoFactura {
  id        Int      @id @default(autoincrement())
  facturaId Int
  factura   Factura  @relation(fields: [facturaId], references: [id])
  nombre    String   // nombre original del archivo
  url       String   // ruta donde quedÃ³ guardado (S3, disco, etc.)
  createdAt DateTime @default(now())
}

model Aprobacion {
  id          Int              @id @default(autoincrement())
  visitaId    Int
  visita      Visita           @relation(fields: [visitaId], references: [id])

  rol         RolAprobacion
  estado      EstadoAprobacion @default(pendiente)
  comentario  String?
  fecha       DateTime         @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EstadoVisita {
  pendiente
  aprobada
  rechazada
  completada
}

enum EstadoAprobacion {
  pendiente
  aprobado
  rechazado
}

enum TipoAprobador {
  null
  suministros
  adquisiciones
}

enum RolAprobacion {
  vicepresidencia
  tiquetes
  transporte
}
